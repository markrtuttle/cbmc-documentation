<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CBMC: restrict-function-pointer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CBMC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_runner_work_cbmc-documentation_cbmc-documentation_doc_architectural_restrict-function-pointer.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">restrict-function-pointer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>restricting-function-pointers Restricting function pointers</p>
<p>In this document, we describe the <code>goto-instrument</code> feature to replace calls through function pointers by case distinctions over calls to given sets of functions.</p>
<h3><a class="anchor" id="motivation"></a>
Motivation</h3>
<p>The CPROVER framework includes a goto program transformation pass <code><a class="el" href="remove__function__pointers_8cpp.html#adcbbb61dec4ade79261bdbd77f4ebb52">remove_function_pointers()</a></code> to resolve calls to function pointers to direct function calls. The pass is needed by <code>cbmc</code>, as symbolic execution itself can’t handle calls to function pointers. In practice, the transformation pass works as follows:</p>
<p>Given that there are functions with these signatures available in the program: </p><pre class="fragment">int f(int x);
int g(int x);
int h(int x);
</pre><p>And we have a call site like this: </p><pre class="fragment">typedef int(*fptr_t)(int x);
void call(fptr_t fptr) {
  int r = fptr(10);
  assert(r &gt; 0);
}
</pre><p>Function pointer removal will turn this into code similar to this: </p><pre class="fragment">void call(fptr_t fptr) {
  int r;
  if(fptr == &amp;f) {
    r = f(10);
  } else if(fptr == &amp;g) {
    r = g(10);
  } else if(fptr == &amp;h) {
    r = h(10);
  } else {
    // sanity check
    assert(false);
    assume(false);
  }
  return r;
}
</pre><p>This works well enough for simple cases. However, this is a very simple replacement only based on the signature of the function (and whether or not they have their address taken somewhere in the program), so if there are many functions matching a particular signature, or if some of these functions are expensive in symex (e.g.&#160;functions with lots of loops or recursion), then this can be a bit cumbersome - especially if we, as a user, already know that a particular function pointer will only resolve to a single function or a small set of functions. The <code>goto-instrument</code> option <code>--restrict-function-pointer</code> allows to manually specify this set of functions.</p>
<h3><a class="anchor" id="example"></a>
Example</h3>
<p>Take the motivating example above. Let us assume that we know for a fact that <code>call</code> will always receive pointers to either <code>f</code> or <code>g</code> during actual executions of the program, and symbolic execution for <code>h</code> is too expensive to simply ignore the cost of its branch. For this, we will label the places in each function where function pointers are being called, to this pattern: </p><pre class="fragment">&lt;function-name&gt;.function_pointer_call.&lt;N&gt;
</pre><p>where <code>N</code> is referring to which function call it is - so the first call to a function pointer in a function will have <code>N=1</code>, the 5th <code>N=5</code> etc, or </p><pre class="fragment">&lt;function-name&gt;.&lt;label&gt;
</pre><p>when the function call is labelled.</p>
<p>We can call <code>goto-instrument --restrict-function-pointer call.function_pointer_call.1/f,g in.gb out.gb</code>. This can be read as</p>
<blockquote class="doxtable">
<p>For the first call to a function pointer in the function <code>call</code>, assume that it can only be a call to <code>f</code> or <code>g</code> </p>
</blockquote>
<p>The resulting output (written to goto binary <code>out.gb</code>) looks similar to the original example, except now there will not be a call to <code>h</code>: </p><pre class="fragment">void call(fptr_t fptr) {
  int r;
  if(fptr == &amp;f) {
    r = f(10);
  } else if(fptr == &amp;g) {
    r = g(10);
  } else {
    // sanity check
    assert(false);
    assume(false);
  }
  return r;
}
</pre><p>Another example: Imagine we have a simple virtual filesystem API and implementation like this: </p><pre class="fragment">typedef struct filesystem_t filesystem_t;
struct filesystem_t {
  int (*open)(filesystem_t *filesystem, const char* file_name);
};

int fs_open(filesystem_t *filesystem, const char* file_name) {
  filesystem-&gt;open(filesystem, file_name);
}

int nullfs_open(filesystem_t *filesystem, const char* file_name) {
  return -1;
}

filesystem_t nullfs_val = {.open = nullfs_open};
filesystem *const nullfs = &amp;nullfs_val;

filesystem_t *get_fs_impl() {
  // some fancy logic to determine
  // which filesystem we're getting -
  // in-memory, backed by a database, OS file system
  // - but in our case, we know that
  // it always ends up being nullfs
  // for the cases we care about
  return nullfs;
}
int main(void) {
  filesystem_t *fs = get_fs_impl();
  assert(fs_open(fs, "hello.txt") != -1);
}
</pre><p>In this case, the assumption is that <em>we</em> know that in our <code>main</code>, <code>fs</code> can be nothing other than <code>nullfs</code>; But perhaps due to the logic being too complicated symex ends up being unable to figure this out, so in the call to <code>fs_open()</code> we end up branching on all functions matching the signature of <code>filesystem_t::open</code>, which could be quite a few functions within the program. Worst of all, if its address is ever taken in the program, as far as the “dumb” function pointer removal is concerned it could be <code>fs_open()</code> itself due to it having a matching signature, leading to symex being forced to follow a potentially infinite recursion until its unwind limit.</p>
<p>In this case we can again restrict the function pointer to the value which we know it will have: </p><pre class="fragment">--restrict-function-pointer fs_open.function_pointer_call.1/nullfs_open
</pre><h3><a class="anchor" id="loading-from-file"></a>
Loading from file</h3>
<p>If you have many places where you want to restrict function pointers, it’d be a nuisance to have to specify them all on the command line. In these cases, you can specify a file to load the restrictions from instead, via the <code>--function-pointer-restrictions-file</code> option, which you can give the name of a JSON file with this format: </p><pre class="fragment">{
  "function_call_site_name": ["function1", "function2", ...],
   ...
}
</pre><p><b>Note:</b> If you pass in multiple files, or a mix of files and command line restrictions, the final restrictions will be a set union of all specified restrictions.</p>
<p><b>Note:</b> as of now, if something goes wrong during type checking (i.e.&#160;making sure that all function pointer replacements refer to functions in the symbol table that have the correct type), the error message will refer to the command line option <code>--restrict-function-pointer</code> regardless of whether the restriction in question came from the command line or a file.</p>
<p>Last modified: 2022-09-21 18:16:17 -0400 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
